<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>单词填空游戏</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            text-align: center;
            background-color: #e1f5fe;
            padding: 20px;
        }
        h1 {
            color: #00796b;
            font-size: 36px;
            font-weight: bold;
        }
        .input-container {
            margin: 30px 0;
        }
        .input-container input[type="file"] {
            padding: 15px;
            font-size: 16px;
            background-color: #00796b;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            width: 200px;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s, transform 0.3s;
        }
        .input-container input[type="file"]:hover {
            background-color: #004d40;
        }
        .input-container input[type="file"]:active {
            transform: scale(0.95);
        }
        .question {
            font-size: 28px;
            font-weight: bold;
            margin: 20px;
            color: #01579b;
            padding: 10px;
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
            display: inline-block;
        }
        .image-container {
            width: 200px;
            height: 200px;
            margin: 20px auto;
            border-radius: 10px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .image {
            max-width: 100%;
            max-height: 100%;
        }
        .letters-container {
            display: flex;
            justify-content: center;
            margin: 20px;
        }
        .letter-card {
            width: 60px;
            height: 60px;
            margin: 5px;
            border: 2px solid #00796b;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            background-color: #ffffff;
            border-radius: 15px;
            transition: background-color 0.3s, transform 0.3s;
        }
        .hidden {
            background-color: #cfd8dc;
        }
        .options {
            margin-top: 30px;
            display: flex;
            justify-content: center;
        }
        .options button {
            padding: 20px 30px;
            font-size: 18px;
            cursor: pointer;
            border-radius: 10px;
            margin: 0 15px;
            background-color: #ff7043;
            color: white;
            border: none;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s, transform 0.3s;
        }
        .options button:hover {
            background-color: #f4511e;
        }
        .options button:active {
            transform: scale(0.95);
        }
        .popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0px 4px 15px rgba(0, 0, 0, 0.3);
            text-align: center;
            width: 300px;
            z-index: 1000;
            font-size: 20px;
        }
        .popup .popup-message {
            font-size: 24px;
            font-weight: bold;
            color: #000000;
            margin-bottom: 20px;
        }
        .popup .popup-button {
            padding: 10px 20px;
            background-color: #00796b;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 18px;
        }
        .popup .popup-button:hover {
            background-color: #004d40;
        }
        .popup.correct {
            border-left: 5px solid #4caf50;
        }
        .popup.incorrect {
            border-left: 5px solid #f44336;
        }
    </style>
</head>
<body>

<h1>单词填空游戏</h1>

<!-- 上传文件按钮 -->
<div class="input-container">
    <input type="file" id="uploadExcel" accept=".xlsx, .xls" />
</div>

<div id="game"></div>

<div id="popup" class="popup">
    <div class="popup-message"></div>
    <button class="popup-button" onclick="closePopup()">继续</button>
</div>

<script>
    let wordsData = [];
    let currentWordIndex = 0;

    // 读取并解析上传的Excel文件
    function handleFileUpload(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = e.target.result;
                const workbook = XLSX.read(data, { type: 'binary' });
                const sheetName = workbook.SheetNames[0];  // 默认读取第一个sheet
                const sheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(sheet);
                console.log('Parsed Excel data:', jsonData);

                if (jsonData.length > 0 && jsonData[0].English && jsonData[0].Chinese && jsonData[0]['Image Path']) {
                    wordsData = jsonData.map(row => ({
                        english: row['English'], 
                        chinese: row['Chinese'],
                        image: row['Image Path']
                    }));
                    console.log('Processed game data:', wordsData);
                    
                    // 隐藏上传按钮并开始游戏
                    document.getElementById('uploadExcel').style.display = 'none';
                    displayGame(wordsData[currentWordIndex]);  // 开始游戏
                } else {
                    alert('文件格式不正确，请确保列名为: English, Chinese, Image Path');
                }
            };
            reader.readAsBinaryString(file);
        }
    }

    document.getElementById('uploadExcel').addEventListener('change', handleFileUpload, false);

    // 随机生成错误选项，增加迷惑性
    function getRandomLetterOptions(correctWord) {
        const options = new Set([correctWord]);

        while (options.size < 4) {
            let incorrectWord = correctWord.split('');
            const randIndex = Math.floor(Math.random() * correctWord.length);

            // 随机修改一个字母，确保生成的是有迷惑性的错误答案
            incorrectWord[randIndex] = String.fromCharCode(97 + Math.floor(Math.random() * 26));

            options.add(incorrectWord.join(''));
        }

        return Array.from(options);
    }

    // 打乱选项顺序
    function shuffleOptions(options) {
        for (let i = options.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [options[i], options[j]] = [options[j], options[i]];  // 交换元素
        }
    }

    // 随机抠取连续位置的字母
    function getRandomMissingWord(word) {
        const missingLength = Math.floor(word.length / 2); // 随机选择空缺字母的长度（一半）
        const start = Math.floor(Math.random() * (word.length - missingLength)); // 随机选择一个起始位置

        const missingWord = word.slice(start, start + missingLength); // 提取空缺的连续字母
        return { wordWithMissingLetters: word.replace(missingWord, "_".repeat(missingLength)), missingWord };
    }

    // 显示游戏内容
    function displayGame(wordData) {
        const word = wordData.english;
        const imagePath = wordData.image;
        const chineseTranslation = wordData.chinese;

        const { wordWithMissingLetters, missingWord } = getRandomMissingWord(word);

        const options = getRandomLetterOptions(missingWord);
        shuffleOptions(options);

        // 创建游戏问题
        const question = document.createElement('div');
        question.classList.add('question');
        question.innerHTML = `请根据以下中文提示，猜测英语单词： <br><strong>${chineseTranslation}</strong>`;

        // 创建图片容器
        const imageContainer = document.createElement('div');
        imageContainer.classList.add('image-container');

        const image = document.createElement('img');
        image.classList.add('image');
        image.src = imagePath;

        // 图片加载失败时显示中文
        image.onerror = function () {
            imageContainer.innerHTML = chineseTranslation;
            imageContainer.style.fontSize = '24px';
            imageContainer.style.color = '#00796b';
            imageContainer.style.fontWeight = 'bold';
        };

        imageContainer.appendChild(image);

        // 创建字母卡片
        const lettersContainer = document.createElement('div');
        lettersContainer.classList.add('letters-container');

        wordWithMissingLetters.split('').forEach((letter, index) => {
            const letterCard = document.createElement('div');
            letterCard.classList.add('letter-card');
            letterCard.innerText = letter;
            lettersContainer.appendChild(letterCard);
        });

        // 创建选项按钮
        const optionsContainer = document.createElement('div');
        optionsContainer.classList.add('options');

        options.forEach(option => {
            const button = document.createElement('button');
            button.innerHTML = option;
            button.onclick = () => {
                if (option === missingWord) {
                    showPopup("回答正确！", "correct");
                    currentWordIndex++;
                    if (currentWordIndex < wordsData.length) {
                        setTimeout(() => displayGame(wordsData[currentWordIndex]), 1500);
                    } else {
                        setTimeout(() => alert("恭喜完成所有单词！游戏结束。"), 1500);
                    }
                } else {
                    showPopup("回答错误，请再试一次！", "incorrect");
                }
            };
            optionsContainer.appendChild(button);
        });

        // 插入页面
        const gameContainer = document.getElementById('game');
        gameContainer.innerHTML = '';
        gameContainer.appendChild(imageContainer);  // 图片或中文提示
        gameContainer.appendChild(question);  // 中文问题在图片下方
        gameContainer.appendChild(lettersContainer);
        gameContainer.appendChild(optionsContainer);
    }

    // 显示提示框
    function showPopup(message, type) {
        const popup = document.getElementById('popup');
        const popupMessage = popup.querySelector('.popup-message');
        popupMessage.textContent = message;
        popup.classList.add(type);
        popup.style.display = 'block';
    }

    // 关闭提示框
    function closePopup() {
        const popup = document.getElementById('popup');
        popup.style.display = 'none';
        popup.classList.remove('correct', 'incorrect');
    }
</script>

</body>
</html>
